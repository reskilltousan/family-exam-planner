# 実装タスクリスト

- Phase 1 (MVP): セクション1〜4
- /auth に外部ログイン（Google/Apple/GitHub）を残しつつ、メール/パスワード＋メンバー登録フォームを復活。API失敗時はローカルfamilyIdをフォールバック。
- next-auth で Google/Apple/GitHub 外部ログインに移行 (/api/auth/[...nextauth], /auth はプロバイダボタン表示)。
- ウィークビューのタスクもクリックで詳細モーダルを開けるよう修正。
- ウィークビューの縦幅を調整し、タスクが多い場合はスクロールで表示するよう改善。
- イベント追加フォームをモーダル化し、クイックアクションから起動。イベント一覧からの詳細モーダル連動も修正。
- イベント一覧からも詳細モーダルを開けるよう修正（onSelectEvent を接続）。
- ウィークビューでタスクも表示し、メンバー名を選択反映するよう修正。
- タスク詳細の担当編集をプルダウン（メンバー一覧）に変更し、ステータス文言を日本語（未対応/進行中/完了）に統一。ウィークビューにタスクも表示、イベント/タスクのメンバー表示を選択メンバー名に揃え、イベント一覧の詳細をモーダル編集と連動。
- タスク詳細の担当編集をプルダウン選択に変更（メンバー一覧から選択）。
- ヘッダーに familyId を表示し、localStorage から読み込むように改善（切替/ログイン文言も切替）。
- family新規作成でAPI失敗時にローカルfamilyIdを設定するフォールバックを追加（メッセージ表示付き）。
- family新規作成のメンバー入力を可変にし、「メンバーを追加」ボタンで人数を増やせるように改善。
- Phase 2 (すえさん案拡張): セクション5以降で管理

# Phase 1

## 役割分担（3名体制）
- メンバーA（バックエンド/DB）: セクション1全般、2.1、2.3、4.1(バックエンド側)。Prismaスキーマ/マイグレーション/種別ロジック/コンフリクト計算を担当。
- メンバーB（外部連携/インフラ）: 2.2（Google OAuth/外部イベント保存）、4.1(インフラ面)、環境変数/秘密情報管理、デプロイ設定。
- メンバーC（フロントエンド/UX/テスト）: セクション3全般、4.2、4.3。カレンダーUI・子ども別ビュー・フォーム/バリデーション/表示ロジックと、テスト/受入確認を担当。

## セクション1：データモデル実装
- [x] 1.1 Prisma スキーマを定義する
  - Family/Member/Event/EventParticipant/Task/EventNote/ExternalEvent/OAuthToken を schema.prisma に追加し、start/end の整合性など基本バリデーションをコメントで明示。
  - Prisma クライアント初期化 (lib/db.ts) を作成し、環境変数（本番: Azure DB, ローカル: SQLite も可）を想定した設定にする。
- [x] 1.2 マイグレーション/シードの初期セットアップ
  - prisma migrate 用スクリプトを追加し、開発用シード（ダミーの family/member/event/task）を準備して初期表示ができる状態にする。

## セクション2：ビジネスロジック実装
- [x] 2.1 イベント/タスク/メンバーの Route Handlers を実装する
  - /api/events (POST/GET), /api/events/[id] (PUT/DELETE), /api/events/[id]/tasks, /api/members の CRUD を design.md の処理フロー1-2に沿って実装。
  - familyId テナンシの検証と共通レスポンス構造を整える。
- [x] 2.2 Google カレンダー読み取りと外部イベント保存
  - /api/google/auth (開始/コールバック) と /api/google/events を実装し、OAuth トークンを OAuthToken に保存、外部イベントを ExternalEvent に格納して返却（処理フロー4）。
  - トークン期限切れ時のリフレッシュと再認可要求のハンドリングを入れる。
- [x] 2.3 コンフリクト検知ロジックを実装する
  - design.md の処理フロー5に基づき、must イベントの時間重複判定（子ども/保護者単位）を lib/conflict.ts として実装し、カレンダーAPI/クライアントで利用可能にする。

## セクション3：インターフェース実装
- [x] 3.1 ダッシュボードUIを構築する
  - page.tsx を置き換え、CalendarView（週/月切替、フィルタ付き）、ChildWeeklyPanel、Google 連携ステータス導線を配置。
  - イベント/タスクの CRUD モーダル/ドロワーを組み込む。
- [x] 3.2 入力バリデーションとフォーム実装
  - EventFormDrawer/TaskListPanel のクライアントバリデーション（必須・時間逆転チェック）と API エラーの表示を実装。
  - メンバー選択・担当者割当 UI を作成。
- [x] 3.3 表示ロジックとフォーマット
  - Google外部イベントを区別表示（アイコン/スタイル）し、コンフリクト結果をカレンダー上で警告表示。
  - タスクステータス更新やメモ表示を ChildWeeklyPanel と詳細ビューで反映。

## セクション4：統合とテスト
- [x] 4.1 データフロー統合
  - フロントから API 呼び出し → DB → 再フェッチまでの一連の流れを接続し、キャッシュ/再検証戦略（SWR）を設定。
- [x] 4.2 基本テストを追加
  - conflict 判定のユニットテスト、イベント API のハンドラ単体テストを追加（Vitest + Prisma sqlite DB push）。
- [x] 4.3 受入基準の自己チェック
  - 確認結果（2025-12-09時点）
    - カレンダー週/月ビューとフィルタUI：実装済（週/月切替、メンバー/タイプフィルタ、Google予定重ね表示、詳細ポップオーバー）。
    - メンバー/家族管理UI：実装済（family作成、familyId入力/コピー/クリア、メンバーCRUD）。
    - タスクUI：実装済（追加・ステータス変更・削除確認・担当者選択・期日編集、エラー表示）。
    - イベントメモ/ジャーナル：実装済（メモ追加/閲覧）。
    - Google連携UX：実装済（OAuth開始導線、連携状態表示、再認可リンク、再取得、期限切れバッジ、token自動リフレッシュ）。
    - バリデーションUI：実装済（イベント必須/時間逆転、メンバー/タスク追加エラー表示）。
    - 認証/家族テナンシUI担保：family入力/作成UIとヘッダー送信で担保（本格認証は今後の課題）。

## セクション5：Phase 2（すえさん案）Backlog

- [ ] P2-1 受験テンプレートの設計
  - [x] 代表的なテンプレ（模試、本番試験A/B日程など）のタスク洗い出し（seedに登録）
  - [x] schema.prisma の拡張（Template, TemplateTask など）
  - [x] テンプレ選択UIのたたき台実装（作成/一覧/削除、イベント作成時に自動生成）
  - [x] テンプレタグ付けと検索フィルタの追加（タグ表示バッジ、一覧検索）
  - [x] 認証フォームのバリデーション強化（必須/長さのフィールド内エラー表示）
  - [x] Cookieセッションでのfamily選択UI（/api/auth/me, ログイン/サインアップ時にcookieセット、ログアウト）

- [ ] P2-2 週次PDF出力
  - [ ] 子ども別「印刷用」レイアウトの設計
  - [ ] サーバーサイドでのPDF生成 or ブラウザ印刷想定のスタイル調整
  - [ ] Tech0発表用ダミーデータでの確認

- [ ] P2-3 メモ/モチベーションUIの強化
  - [ ] EventNote のUI追加（簡易コメント入力）
  - [ ] 「Good job!」などのスタンプ/リアクションの簡易実装

## 直近の実装ログ（2025-12-10）
- トップUIを Apple HIG 風に刷新し、カード DnD 並べ替えを正式採用。ウィークビューを月曜始まり＋週ナビゲーション付きに拡張し、イベント/タスククリックで詳細シートを表示。
- イベント/タスク詳細シートを ESC でも閉じられるように改善。
- イベント/タスク詳細シートに編集モードを追加。編集中は ESC で閉じないよう制御。
- family新規作成時に任意の家族メンバー名を入力できるよう `/auth` にフィールド追加。保存したメンバー名をトップUIに反映（ローカル表示用）。
- 詳細シートの選択切替を修正（キー付与でイベント/タスクを正しく開き、編集中ESC制御を維持）。
- イベント追加フォームをトップに統合（familyId 設定時に `/api/events` POST + ローカル反映）。
- ヘッダーに「新規作成/ログイン」導線を追加し、専用ページ `/auth` を新設（サインアップ/ログイン/Cookie復元で familyId を保存→トップへ）。
- `lucide-react` 依存追加でビルドエラー解消。

## Git運用メモ
- 各メンバーは担当領域ごとにブランチ作成（例: feature/backend-prisma, feature/google-sync, feature/ui-dashboard）。
- PR は別メンバー1名がレビュー。共通ロジック（コンフリクト検知など）は全員で確認。
- main へのマージ前に lint/test を実行し、tasks.md と本ファイルの該当セクションを更新。
